<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <link rel="stylesheet" href="/styles.css">
    <meta charset="UTF-8">
    <title>расписание</title>
    <style>
        table {
            width: 100%;
            margin-bottom: 20px;
            border: 1px solid #dddddd;
            border-collapse: collapse;
        }

        table th {
            font-weight: bold;
            padding: 5px;
            background: #efefef;
            border: 1px solid #dddddd;
        }

        table td {
            border: 1px solid #dddddd;
            padding: 5px;
        }
    </style>
</head>

<body>
<h1>Schedule</h1>
<div class="topnav">
    <a></a>
</div>

<div id="myElement" data-default-days="[[${defaultDays}]]"></div>
<table id="schedule">
    <thead>
    <tr>
        <td></td>
        <td></td>
        <th th:each="dayOfWeek : ${defaultDays}" th:text="${dayOfWeek.name}">day</th>
    </tr>
    </thead>


    <tbody>
    <tr th:each="timeIndex : ${#numbers.sequence(0, defaultStartTimes.size() - 1)}">

        <td th:text="${defaultStartTimes[timeIndex].toString()}">time</td>
        <td th:text="${defaultEndTimes[timeIndex].toString()}">time</td>

        <td th:each="dayIndex : ${#numbers.sequence(0,defaultDays.size()-1)}"
            th:text="${defaultContent[timeIndex][dayIndex]}"></td>

    </tr>
    </tbody>

</table>


<div>
    <button id="editButton">Редактировать</button>
    <button id="saveButton">Сохранить изменения</button>

</div>
<script th:inline="javascript">

    const defaultDays = [[${defaultDays}]];
    const allDays = [[${allDays}]];


    // function addCounter() {
    //     let currentValue = 0;
    //
    //     function updateCounter() {
    //         const counterDisplay = document.getElementById('counterDisplay');
    //         counterDisplay.textContent = currentValue;
    //     }
    //
    //
    //     function increaseCounter() {
    //         currentValue++;
    //         updateCounter();
    //     }
    //
    //
    //     function decreaseCounter() {
    //         currentValue--;
    //         updateCounter();
    //     }
    //
    //
    //     const incrementButton = document.createElement('button');
    //     incrementButton.textContent = '▲';
    //     incrementButton.addEventListener('click', increaseCounter);
    //
    //     const decrementButton = document.createElement('button');
    //     decrementButton.textContent = '▼';
    //     decrementButton.addEventListener('click', decreaseCounter);
    //
    //
    //     const counterDisplay = document.createElement('div');
    //     counterDisplay.id = 'counterDisplay';
    //     counterDisplay.textContent = currentValue;
    //
    //
    //     document.body.appendChild(incrementButton);
    //     document.body.appendChild(decrementButton);
    //     document.body.appendChild(counterDisplay);
    // }
    //

    const scheduleTable = document.getElementById('schedule');
    let scheduleTableArr = new Array(scheduleTable.rows.length);
    // // var defaultDaysFromThymeleaf = [[${defaultDays}]];
    // console.log(defaultDaysFromThymeleaf);

    for (let i = 0; i < scheduleTable.rows.length; i++) {
        scheduleTableArr[i] = new Array(scheduleTable.rows[0].cells.length);
    }

    for (let i = 0; i < scheduleTable.rows.length; i++) {
        for (let j = 0; j < scheduleTable.rows[0].cells.length; j++) {
            scheduleTableArr[i][j] = scheduleTable.rows[i].cells[j].innerHTML;
        }
    }

    // function addForms(table) {
    //     let currCell;
    //     for (let i = 1; i < table.rows.length; i++) {
    //         for (let j = 2; j < table.rows[0].cells.length; j++) {
    //             currCell = table.rows[i].cells[j];
    //             const form = document.createElement("form");
    //             form.action = "";
    //             form.method = "put";
    //             const input = document.createElement("input");
    //             input.type = "text";
    //             input.value = currCell.innerHTML;
    //             form.appendChild(input);
    //             currCell.innerHTML = "";
    //             currCell.appendChild(form);
    //         }
    //     }
    // }

    function startEditing() {
        const editButton = document.getElementById('editButton');
        const table = document.getElementById('schedule');

        let currCell;
        for (let i = 1; i < table.rows.length; i++) {
            for (let j = 0; j < table.rows[0].cells.length; j++) {
                currCell = table.rows[i].cells[j];
                const form = document.createElement("form");
                form.action = "";
                form.method = "put";
                const input = document.createElement("input");
                input.type = "text";
                input.value = currCell.innerHTML;
                form.appendChild(input);
                currCell.innerHTML = "";
                currCell.appendChild(form);
            }
        }

        const plusButtonTime = document.createElement('button');
        plusButtonTime.textContent = '+';
        editButton.insertAdjacentElement('afterend', plusButtonTime);


        const minusButtonTime = document.createElement('button');
        minusButtonTime.textContent = '-';
        plusButtonTime.insertAdjacentElement('afterend', minusButtonTime);

        const plusButtonDay = document.createElement('button');
        for (let i = 0; i < table.rows.length; i++) {
            plusButtonDay.setAttribute('id', 'plusButtonDay');
            plusButtonDay.textContent = '+';


            const cell = table.rows[i].insertCell(-1);
            if (i === 0) {
                cell.appendChild(plusButtonDay);
            } else {
                cell.innerHTML = "";
            }
        }
        console.log(table.rows[0].cells.length);

        const minusButtonDay = document.createElement('button');
        minusButtonDay.setAttribute('id', 'minusButtonDay');
        minusButtonDay.textContent = '-';
        plusButtonDay.insertAdjacentElement('afterend', minusButtonDay);

        editButton.remove();

        plusButtonTime.addEventListener('click', addTimeRow);
        minusButtonTime.addEventListener('click', removeTimeRow);

        plusButtonDay.addEventListener('click', addDay);
        minusButtonDay.addEventListener('click', removeDay);

        console.log("aboba")
        console.log(scheduleTableArr);
    }

    const editButton = document.getElementById('editButton');
    editButton.addEventListener('click', startEditing);

    function addTimeRow() {
        const table = document.getElementById('schedule');
        let newRow = table.insertRow();
        for (let i = 0; i < table.rows[0].cells.length - 1; i++) {
            let currCell = newRow.insertCell();
            const form = document.createElement("form");
            form.action = "";
            form.method = "put";
            const input = document.createElement("input");
            input.type = "text";
            input.value = "";
            form.appendChild(input);
            currCell.appendChild(form);
        }
        let newRowArr = [];
        for (let i = 0; i < newRow.cells.length; i++) {
            newRowArr[i] = "";
        }
        scheduleTableArr.push(newRowArr);
        console.log(scheduleTableArr);
    }


    function removeTimeRow() {
        const table = document.getElementById('schedule');
        const rows = table.getElementsByTagName('tr');
        table.deleteRow(rows.length - 1);

        scheduleTableArr.pop();
        console.log(scheduleTableArr);
    }


    // function addDay() {
    //
    //     const table = document.getElementById('schedule');
    //     const columnCount = table.rows[0].cells.length;
    //
    //
    //     const plusButtonEx = document.getElementById("plusButtonDay");
    //     plusButtonEx.remove();
    //     console.log("abobaaa");
    //     const minusButtonEx = document.getElementById("minusButtonDay");
    //     minusButtonEx.remove();
    //
    //
    //     let currCell;
    //     for (let i = 0; i < table.rows.length; i++) {
    //
    //
    //
    //         let currRow = table.rows[i];
    //         let columnCount = currRow.cells.length;
    //         let cell = currRow.insertCell(columnCount);
    //         scheduleTableArr[i].push("");
    //
    //
    //         const form = document.createElement("form");
    //         form.action = "";
    //         form.method = "put";
    //         const input = document.createElement("input");
    //         input.type = "text";
    //         input.value = "";
    //         form.appendChild(input);
    //         currCell.appendChild(form);
    //     }
    //     console.log(scheduleTableArr);
    //
    //     const plusButtonDay = document.createElement('button');
    //     plusButtonDay.setAttribute('id', 'plusButtonDay');
    //     plusButtonDay.textContent = '+';
    //     const lastColumn = table.rows[0].cells[table.rows[0].cells.length - 1];
    //     lastColumn.insertAdjacentElement('afterend', plusButtonDay);
    //     console.log("hui");
    //     const minusButtonDay = document.createElement('button');
    //     minusButtonDay.setAttribute('id', 'minusButtonDay');
    //     minusButtonDay.textContent = '-';
    //     plusButtonDay.insertAdjacentElement('afterend', minusButtonDay);
    // }


    function addDay() {
        const table = document.getElementById("schedule");
        const rows = table.rows;
        let currCell;
        for (let i = 0; i < rows.length; i++) {


            if (i === 0) {
                const headerRow = table.rows[0];
                const presentDaysAm = defaultDays.length;
                const cellValue = allDays[presentDaysAm].toString();


                currCell = headerRow.insertCell(headerRow.cells.length - 1);
                currCell.innerHTML = cellValue;
                scheduleTableArr[i].push(cellValue);
                defaultDays.push(allDays[presentDaysAm]);
            } else {
                currCell = rows[i].insertCell(rows[i].cells.length - 1);
                const form = document.createElement("form");
                form.action = "";
                form.method = "put";
                const input = document.createElement("input");
                input.type = "text";
                input.value = "";
                form.appendChild(input);
                currCell.appendChild(form);


                scheduleTableArr[i].push("");
            }

        }
        console.log(scheduleTableArr);
    }

    function removeDay() {
        const table = document.getElementById("schedule");
        const columnCount = table.rows.length;
        for (let i = 0; i < columnCount; i++) {
            table.rows[i].deleteCell(table.rows[i].cells.length - 2);
            scheduleTableArr[i].pop();
        }
        console.log(scheduleTableArr);
    }

    function saveChanges() {
        const table = document.getElementById("schedule");
        for (let row = 0; row < table.rows.length; row++) {
            for (let col = 0; col < table.rows[0].cells.length; col++) {
                const form = table.rows[row].cells[col].querySelector("form");
                if (form) {
                    scheduleTableArr[row][col] = form.querySelector('input').value;
                }
            }
        }

        console.log(scheduleTableArr);

        for (let row = 1; row < scheduleTableArr.length; row++) {
            for (let col = 2; col < scheduleTableArr[0].length; col++) {
                let day = {
                    id: {
                        startTime: scheduleTableArr[row][0],
                        endTime: scheduleTableArr[row][1],
                        day: scheduleTableArr[0][col],
                    },
                    content: scheduleTableArr[row][col],
                    schedule: {
                        scheduleId: 1
                    }
                }

                fetch('http://localhost:8080', {
                    method: 'POST',
                    headers: {
                        'Content-type': 'application/json'
                    },
                    body: JSON.stringify(day),
                }).then(response => {
                    if (response.ok) {
                        console.log('POST запрос успешно выполнен');
                        console.log(day);
                    } else {
                        console.error('Ошибка выполнения POST запроса');
                    }
                })
                    .catch(error => {
                        console.error('Произошла ошибка:', error);
                    });

            }


            console.log(scheduleTableArr);
        }
    }

    function postRequest() {
        var form = document.getElementsByTagName('form');

        console.log(scheduleTableArr);

        for (let i = 1; i < scheduleTableArr.length; i++) { //идем по строкам пока; попробуем один пн поменять
            let day = {
                id: {
                    startTime: scheduleTableArr[i][0],
                    endTime: scheduleTableArr[i][1],
                    day: scheduleTableArr[0][2],
                },
                content: scheduleTableArr[i][2],
                schedule: {
                    scheduleId: 1
                }
            }

            fetch('http://localhost:8080', {
                method: 'POST',
                headers: {
                    'Content-type': 'application/json'
                },
                body: JSON.stringify(day),
            }).then(response => {
                if (response.ok) {
                    console.log('POST запрос успешно выполнен');
                    console.log(day);
                } else {
                    console.error('Ошибка выполнения POST запроса');
                }
            })
                .catch(error => {
                    console.error('Произошла ошибка:', error);
                });

        }

    }


    document.getElementById('saveButton').addEventListener('click', saveChanges);
</script>

</body>
</html>
