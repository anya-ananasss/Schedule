<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <link rel="stylesheet" href="/styles.css">
    <meta charset="UTF-8">
    <title>расписание</title>
    <style>
        table {
            width: 100%;
            margin-bottom: 20px;
            border: 1px solid #dddddd;
            border-collapse: collapse;
        }

        table th {
            font-weight: bold;
            padding: 5px;
            background: #efefef;
            border: 1px solid #dddddd;
        }

        table td {
            border: 1px solid #dddddd;
            padding: 5px;
        }
    </style>
</head>

<body>
<h1>Schedule</h1>
<div class="topnav">
    <a></a>
</div>

<div id="myElement" data-default-days="[[${defaultDays}]]"></div>
<table id="schedule">
    <thead>
    <tr>
        <td></td>
        <td></td>
        <th th:each="dayOfWeek : ${defaultDays}" th:text="${dayOfWeek.name}">day</th>
        <td></td>
    </tr>
    </thead>


    <tbody>
    <tr th:each="timeIndex : ${#numbers.sequence(0, defaultStartTimes.size() - 1)}">

        <td th:text="${defaultStartTimes[timeIndex].toString()}">time</td>
        <td th:text="${defaultEndTimes[timeIndex].toString()}">time</td>

        <td th:each="dayIndex : ${#numbers.sequence(0,defaultDays.size()-1)}"
            th:text="${defaultContent[timeIndex][dayIndex]}"></td>
        <td></td>

    </tr>
    </tbody>

</table>


<div>
    <button id="editButton">Редактировать</button>
    <button id="saveButton" style="display: none">Сохранить изменения</button>

</div>
<div id="errorMessage"></div>
<script th:inline="javascript">

    const defaultDays = [[${defaultDays}]];
    const allDays = [[${allDays}]];

    const scheduleTable = document.getElementById('schedule');
    let scheduleTableArr = new Array(scheduleTable.rows.length);


    for (let i = 0; i < scheduleTable.rows.length; i++) {
        scheduleTableArr[i] = new Array(scheduleTable.rows[0].cells.length - 1);
    }

    for (let i = 0; i < scheduleTable.rows.length; i++) {
        for (let j = 0; j < scheduleTable.rows[0].cells.length - 1; j++) {
            scheduleTableArr[i][j] = scheduleTable.rows[i].cells[j].innerHTML;
        }
    }


    const editButton = document.getElementById('editButton');
    const saveButton = document.getElementById("saveButton");


    const plusButtonTime = document.createElement('button');
    const minusButtonTime = document.createElement('button');

    const plusButtonDay = document.createElement('button');
    const minusButtonDay = document.createElement('button');

    function startEditing() {
        saveButton.style.display = "block";
        const table = document.getElementById('schedule');
        let formsCounter = 0;

        let currCell;
        for (let j = 0; j < table.rows[0].cells.length - 1; j++) {
            for (let i = 1; i < table.rows.length; i++) {
                currCell = table.rows[i].cells[j];
                const form = document.createElement("form");
                form.id = "form" + formsCounter;
                formsCounter++;
                form.action = "";
                form.method = "put";
                const input = document.createElement("input");
                input.type = "text";
                input.value = currCell.innerHTML;
                form.appendChild(input);
                currCell.innerHTML = "";
                currCell.appendChild(form);
            }

        }


        plusButtonTime.textContent = '+';
        editButton.insertAdjacentElement('afterend', plusButtonTime);


        minusButtonTime.textContent = '-';
        plusButtonTime.insertAdjacentElement('afterend', minusButtonTime);


        plusButtonDay.textContent = '+';


        const lastCellIndex = table.rows[0].cells.length - 1;
        const cell = table.rows[0].cells[lastCellIndex];
        cell.appendChild(plusButtonDay);

        if (defaultDays.length === 7) {
            plusButtonDay.hidden = true;
        }


        minusButtonDay.setAttribute('id', 'minusButtonDay');
        minusButtonDay.textContent = '-';
        plusButtonDay.insertAdjacentElement('afterend', minusButtonDay);

        editButton.hidden = true;

        plusButtonTime.addEventListener('click', addTimeRow);
        minusButtonTime.addEventListener('click', removeTimeRow);

        plusButtonDay.addEventListener('click', addDay);
        minusButtonDay.addEventListener('click', removeDay);

    }


    editButton.addEventListener('click', startEditing);

    function addTimeRow() {
        const table = document.getElementById('schedule');


        const startTime = prompt("Введите время начала");
        const endTime = prompt("Введите время конца");


        let newRow = table.insertRow();
        for (let i = 0; i < table.rows[0].cells.length - 1; i++) {
            let currCell = newRow.insertCell();
            const form = document.createElement("form");
            form.action = "";
            form.method = "put";
            const input = document.createElement("input");
            input.type = "text";
            if (currCell.cellIndex === 0) {
                input.value = startTime;
            } else if (currCell.cellIndex === 1) {
                input.value = endTime;
            } else {
                input.value = "";
            }
            form.appendChild(input);
            currCell.appendChild(form);
        }
        console.log("пыыыска");
        let newRowArr = Array(scheduleTableArr[0].length);
        for (let i = 0; i < newRowArr.length; i++) {
            if (i === 0) {
                newRowArr[i] = startTime;
            } else if (i === 1) {
                newRowArr[i] = endTime;
            } else {
                newRowArr[i] = "";
            }
        }
        scheduleTableArr.push(newRowArr);
        console.log(scheduleTableArr)


        for (let col = 2; col < table.rows[0].cells.length - 2; col++) { //TODO: почему-2?
            let newDay = {
                id: {
                    startTime: startTime,
                    endTime: endTime,
                    day: scheduleTableArr[0][col]
                },
                content: "",
                schedule: {
                    scheduleId: 1
                }
            };
            console.log(newDay);
            const response = fetch('http://localhost:8080', {
                method: 'POST',
                headers: {
                    'Content-type': 'application/json'
                },
                body: JSON.stringify(newDay)
            });
            if (response.ok) {
                console.log("эээй скуууф скуууфиииик");
            }
            console.log("piska")

        }

    }

    function removeTimeRow() {
        const table = document.getElementById('schedule');
        const rows = table.getElementsByTagName('tr');
        table.deleteRow(rows.length - 1);

        console.log("я кажется влюбилась и этот парень стример");
        const lastRowIndex = table.rows.length - 1;
        const timeToDelete = scheduleTableArr[lastRowIndex][1];

        scheduleTableArr.pop();

        for (let col = 1; col < table.rows[0].cells.length - 2; col++) { //TODO: почему-2?
            console.log(lastRowIndex);
            let toDelete = {
                id: {
                    startTime: scheduleTableArr[lastRowIndex][0],
                    endTime: scheduleTableArr[lastRowIndex][1],
                    day: defaultDays[col - 1],
                },
                content: scheduleTableArr[lastRowIndex][col],
                schedule: {
                    scheduleId: 1
                }
            };
            console.log(toDelete);
            fetch('http://localhost:8080', {
                method: 'DELETE',
                headers: {
                    'Content-type': 'application/json'
                },
                body: JSON.stringify(toDelete)
            })
                .then(response => {
                    if (response.ok) {
                        console.log("эээй скуууф скуууфиииик");
                    } else {
                        console.log("piska");
                    }
                })
                .catch(error => {
                    console.error('Ошибка:', error);
                });
        }
    }


    function addDay() {
        const table = document.getElementById("schedule");
        const rows = table.rows;
        const presentDaysAm = defaultDays.length;
        let newDayName = allDays[presentDaysAm];
        let newDaysArray = [];
        let currCell;
        for (let i = 0; i < rows.length; i++) {


            if (i === 0) {
                const headerRow = table.rows[0];
                const cellValue = allDays[presentDaysAm].toString();

                currCell = headerRow.insertCell(headerRow.cells.length - 1);
                currCell.innerHTML = cellValue;
                scheduleTableArr[i].push(cellValue);
                defaultDays.push(allDays[presentDaysAm]);
                console.log(allDays[presentDaysAm]);
            } else {
                currCell = rows[i].insertCell(rows[i].cells.length - 1);
                const form = document.createElement("form");
                form.action = "";
                form.method = "put";
                const input = document.createElement("input");
                input.type = "text";
                input.value = "";
                form.appendChild(input);
                currCell.appendChild(form);


                scheduleTableArr[i].push("");
            }

        }
        if (defaultDays.length === 7) {
            plusButtonDay.hidden = true;
        } else if (defaultDays.length > 0) {
            minusButtonDay.hidden = false;
        }
        console.log(scheduleTableArr);

        for (let row = 1; row < table.rows.length; row++) { //TODO: по идее можно и не  заморачиваться с массивом, хз, это сейчас не основная проблема
            let newDay = {
                id: {
                    startTime: scheduleTableArr[row][0],
                    endTime: scheduleTableArr[row][1],
                    day: newDayName,
                },
                content: "",
                schedule: {
                    scheduleId: 1
                }
            }
            console.log("ебнулись что ли");
            console.log(newDaysArray);
            console.log("ёбен бобен");
            fetch('http://localhost:8080', {
                method: 'POST',
                headers: {
                    'Content-type': 'application/json'
                },
                body: JSON.stringify(newDay)
            }) .then(response => {
                if (response.ok) {
                    console.log("эээй скуууф скууууф");
                } else {
                    console.log("я больной сука я больной");
                }
            });
        }


    }

    function removeDay() {
        const table = document.getElementById("schedule");
        const rowsAmount = table.rows.length;
        let dayToDelete;
        for (let i = 0; i < rowsAmount; i++) {
            table.rows[i].deleteCell(table.rows[i].cells.length - 2);
            scheduleTableArr[i].pop();

        }


        dayToDelete = defaultDays.pop();
        if (defaultDays.length < 7) {
            plusButtonDay.hidden = false;
        }


        const response = fetch('http://localhost:8080', {
            method: 'DELETE',
            headers: {
                'Content-type': 'application/json'
            },
            body: JSON.stringify(dayToDelete)
        });
        if (response.ok) {
            console.log("разъеб");
        }
        if (defaultDays.length === 0) {
            minusButtonDay.hidden = true;
        }
    }

    async function saveChanges() {

        const table = document.getElementById("schedule");
        let totalUnsuccessfulRequests = 0;


        let formsCounter = 0;


        let inputs = document.querySelectorAll('input[type="text"]');
        console.log(inputs);
        console.log(scheduleTableArr)


        outer: for (let row = 0; row < table.rows.length; row++) {
            for (let col = 0; col < table.rows[0].cells.length - 1; col++) {
                if (formsCounter >= inputs.length) {
                    break outer;
                }
                if (row === 0) {
                    scheduleTableArr[row][col] = table.rows[row].cells[col].innerHTML;
                } else {
                    scheduleTableArr[row][col] = inputs[formsCounter].value;
                }
                formsCounter++;
            }
        }

        console.log(scheduleTableArr);

        const message = document.getElementById("errorMessage");


        for (let row = 1; row < scheduleTableArr.length; row++) {
            for (let col = 2; col < scheduleTableArr[0].length; col++) {
                let day = {
                    id: {
                        startTime: scheduleTableArr[row][0],
                        endTime: scheduleTableArr[row][1],
                        day: scheduleTableArr[0][col],
                    },
                    content: scheduleTableArr[row][col],
                    schedule: {
                        scheduleId: 1
                    }
                }
                console.log(day);
                totalUnsuccessfulRequests += await getUnsuccessfulRequestsAmount(day, totalUnsuccessfulRequests);
            }
        }


        if (totalUnsuccessfulRequests > 0) {
            console.log("penis");

            message.style.color = "red";
            message.textContent = "Произошла ошибка! Проверьте корректность введенных данных";

        } else {
            plusButtonTime.remove();
            minusButtonTime.remove();

            plusButtonDay.remove();
            minusButtonDay.remove();

            editButton.hidden = false;
            saveButton.style.display = "none";

            let formsCounter = 0;
            let inputs = document.querySelectorAll('input[type="text"]');
            outer: for (let row = 1; row < table.rows.length; row++) {
                for (let col = 0; col < table.rows[0].cells.length - 1; col++) {
                    if (formsCounter >= inputs.length) {
                        break outer;
                    }
                    table.rows[row].cells[col].innerHTML = inputs[formsCounter].value;
                    formsCounter++;
                }
            }


            message.style.color = "green";
            message.textContent = "Успешно сохранено!";
        }
    }

    async function getUnsuccessfulRequestsAmount(day, totalUnsuccessfulRequests) {
        let response = await fetch('http://localhost:8080/', {
            method: 'PUT',
            headers: {
                'Content-type': 'application/json'
            },
            body: JSON.stringify(day)
        });
        if (!response.ok) {
            totalUnsuccessfulRequests++;
            console.log("пашли в хуй");
        } else {
            console.log("пашли в пизду");
        }
        return totalUnsuccessfulRequests;
    }


    document.getElementById('saveButton').addEventListener('click', saveChanges)

        //TODO: ОСТАЛОСЬ ТОЛЬКО СДЕЛАТЬ НОРМ ДОБАВЛЕНИЕ ДНЯ и обновление контента внутри

</script>

</body>
</html>
